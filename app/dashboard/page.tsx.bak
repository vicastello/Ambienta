'use client';

import { useEffect, useMemo, useState } from 'react';
import { AppLayout } from '@/components/layout/AppLayout';
import { MultiSelectDropdown } from '@/components/MultiSelectDropdown';
import {
  Area,
  AreaChart,
  CartesianGrid,
  Legend,
  Pie,
  PieChart,
  ResponsiveContainer,
  Tooltip,
  XAxis,
  YAxis,
  Cell,
} from 'recharts';
import {
  ShoppingCart,
  TrendingUp,
  BarChart3,
  ArrowUpRight,
  ArrowDownRight,
} from 'lucide-react';

// Ambienta colors
const AMBIENTA_PRIMARY = '#009DA8';
const AMBIENTA_LIGHT = '#00B5C3';
const AMBIENTA_DARK = '#006E76';
const COLORS_PALETTE = [AMBIENTA_PRIMARY, '#22c55e', '#f97316', '#0ea5e9', '#a855f7'];

type DiaResumo = {
  data: string;
  quantidade: number;
  totalDia: number;
};

type SituacaoResumo = {
  situacao: number;
  descricao: string;
  quantidade: number;
};

type PeriodoResumo = {
  dataInicial: string;
  dataFinal: string;
  dias: number;
  totalPedidos: number;
  totalValor: number;
  totalValorLiquido: number;
  totalFreteTotal: number;
  ticketMedio: number;
  vendasPorDia: DiaResumo[];
  pedidosPorSituacao: SituacaoResumo[];
};

type CanalResumo = {
  canal: string;
  totalValor: number;
  totalPedidos: number;
};

type SituacaoDisponivel = {
  codigo: number;
  descricao: string;
};

type DashboardResumo = {
  periodoAtual: PeriodoResumo;
  periodoAnterior: PeriodoResumo;
  periodoAnteriorCards: PeriodoResumo;
  canais: CanalResumo[];
  canaisDisponiveis: string[];
  situacoesDisponiveis: SituacaoDisponivel[];
};

type DatePreset =
  | 'today'
  | 'yesterday'
  | '7d'
  | 'month'
  | '3m'
  | 'year'
  | 'custom';

type SavedFilters = {
  preset: DatePreset;
  customStart: string | null;
  customEnd: string | null;
  canaisSelecionados: string[];
  situacoesSelecionadas: number[];
};

const FILTERS_STORAGE_KEY = 'tiny_dash_filters_v1';

const COLORS = COLORS_PALETTE;

function formatBRL(valor: number | null | undefined) {
  const n =
    typeof valor === 'number' && Number.isFinite(valor) ? valor : 0;
  return n.toLocaleString('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  });
}

function labelSituacao(s: number) {
  const mapa: Record<number, string> = {
    0: 'Dados incompletos',
    1: 'Aberta',
    2: 'Aprovada',
    3: 'Preparando envio',
    4: 'Faturada',
    5: 'Pronto envio',
    6: 'Enviada',
    7: 'Entregue',
    8: 'Cancelada',
    9: 'Não entregue',
    [-1]: 'Sem situação',
  };
  return mapa[s] ?? `Situação ${s}`;
}

function isoToday() {
  const d = new Date();
  return d.toISOString().slice(0, 10);
}

function addDays(baseIso: string, offset: number) {
  const d = new Date(`${baseIso}T00:00:00`);
  d.setDate(d.getDate() + offset);
  return d.toISOString().slice(0, 10);
}

function startOfMonthFrom(dateIso: string) {
  const d = new Date(`${dateIso}T00:00:00`);
  d.setDate(1);
  return d.toISOString().slice(0, 10);
}

function startOfYearFrom(dateIso: string) {
  const d = new Date(`${dateIso}T00:00:00`);
  d.setMonth(0);
  d.setDate(1);
  return d.toISOString().slice(0, 10);
}

function diffDays(startIso: string, endIso: string): number {
  const a = new Date(`${startIso}T00:00:00`);
  const b = new Date(`${endIso}T00:00:00`);
  const diff = b.getTime() - a.getTime();
  return Math.floor(diff / (24 * 60 * 60 * 1000));
}

type ChartPreset = 'today' | '7d' | '30d' | 'month' | 'custom';

export default function DashboardPage() {
  const [preset, setPreset] = useState<DatePreset>('7d');
  const [customStart, setCustomStart] = useState<string | null>(null);
  const [customEnd, setCustomEnd] = useState<string | null>(null);

  const [resumo, setResumo] = useState<DashboardResumo | null>(null);
  const [loading, setLoading] = useState<boolean>(true);
  const [erro, setErro] = useState<string | null>(null);

  const [canaisSelecionados, setCanaisSelecionados] = useState<string[]>([]);
  const [situacoesSelecionadas, setSituacoesSelecionadas] = useState<number[]>(
    []
  );

  // Estado separado para o gráfico (filtro próprio)
  const [chartPreset, setChartPreset] = useState<ChartPreset>('month');
  const [chartCustomStart, setChartCustomStart] = useState<string | null>(null);
  const [chartCustomEnd, setChartCustomEnd] = useState<string | null>(null);
  const [resumoChart, setResumoChart] = useState<DashboardResumo | null>(null);
  const [loadingChart, setLoadingChart] = useState<boolean>(true);
  const [erroChart, setErroChart] = useState<string | null>(null);
  const [complementLoading, setComplementLoading] = useState<boolean>(false);
  const [complementMsg, setComplementMsg] = useState<string | null>(null);
  const [lastSync, setLastSync] = useState<string | null>(null);
  const [autoComplementedRanges, setAutoComplementedRanges] = useState<Record<string, boolean>>({});

  // 1) Carrega filtros salvos
  useEffect(() => {
    if (typeof window === 'undefined') return;

    try {
      const raw = window.localStorage.getItem(FILTERS_STORAGE_KEY);
      if (!raw) return;

      const saved: SavedFilters = JSON.parse(raw);

      if (saved.preset) setPreset(saved.preset);
      if (saved.customStart) setCustomStart(saved.customStart);
      if (saved.customEnd) setCustomEnd(saved.customEnd);
      if (Array.isArray(saved.canaisSelecionados)) {
        setCanaisSelecionados(saved.canaisSelecionados);
      }
      if (Array.isArray(saved.situacoesSelecionadas)) {
        setSituacoesSelecionadas(saved.situacoesSelecionadas);
      }
    } catch (err) {
      console.error('Erro ao carregar filtros salvos', err);
    }
  }, []);

  // 2) Salva filtros sempre que mudarem
  useEffect(() => {
    if (typeof window === 'undefined') return;

    const toSave: SavedFilters = {
      preset,
      customStart,
      customEnd,
      canaisSelecionados,
      situacoesSelecionadas,
    };

    try {
      window.localStorage.setItem(
        FILTERS_STORAGE_KEY,
        JSON.stringify(toSave)
      );
    } catch (err) {
      console.error('Erro ao salvar filtros', err);
    }
  }, [preset, customStart, customEnd, canaisSelecionados, situacoesSelecionadas]);

  function resolverIntervalo(): { inicio: string; fim: string } {
    const hojeIso = isoToday();

    if (preset === 'today') {
      return { inicio: hojeIso, fim: hojeIso };
    }
    if (preset === 'yesterday') {
      const ontem = addDays(hojeIso, -1);
      return { inicio: ontem, fim: ontem };
    }
    if (preset === '7d') {
      const fim = hojeIso;
      const inicio = addDays(fim, -6);
      return { inicio, fim };
    }
    if (preset === 'month') {
      // Para 'month', usa do 1º do mês até hoje (não o mês inteiro)
      const hoje = new Date(`${hojeIso}T00:00:00`);
      const inicio = startOfMonthFrom(hojeIso);
      return { inicio, fim: hojeIso };
    }
    if (preset === '3m') {
      const fim = hojeIso;
      const dFim = new Date(`${fim}T00:00:00`);
      dFim.setMonth(dFim.getMonth() - 2);
      const inicio = startOfMonthFrom(dFim.toISOString().slice(0, 10));
      return { inicio, fim };
    }
    if (preset === 'year') {
      const fim = hojeIso;
      const inicio = startOfYearFrom(fim);
      return { inicio, fim };
    }
    // custom
    if (customStart && customEnd) {
      return { inicio: customStart, fim: customEnd };
    }
    // fallback: últimos 30 dias
    const fim = hojeIso;
    const inicio = addDays(fim, -29);
    return { inicio, fim };
  }

  async function carregarResumo() {
    try {
      setLoading(true);
      setErro(null);

      const { inicio, fim } = resolverIntervalo();

      const params = new URLSearchParams();
      params.set('dataInicial', inicio);
      params.set('dataFinal', fim);

      if (canaisSelecionados.length) {
        params.set('canais', canaisSelecionados.join(','));
      }
      if (situacoesSelecionadas.length) {
        params.set('situacoes', situacoesSelecionadas.join(','));
      }

      const res = await fetch(
        `/api/tiny/dashboard/resumo?${params.toString()}`,
        { cache: 'no-store' }
      );

      const json = await res.json();

      if (!res.ok) {
        const msg =
          json?.details ||
          json?.message ||
          'Erro ao carregar resumo do dashboard';
        throw new Error(msg);
      }

      setResumo(json as DashboardResumo);
        // Auto-complement para o resumo principal quando preset for 'month'
        try {
          const { inicio, fim } = resolverIntervalo();
          const diasEsperados = 1 + diffDays(inicio, fim);
          const atualDias = (json as DashboardResumo).periodoAtual.vendasPorDia.length ?? 0;
          const key = `${inicio}_${fim}`;
          const already = !!autoComplementedRanges[key];

          if (preset === 'month' && !already && atualDias < diasEsperados) {
            setAutoComplementedRanges((prev) => ({ ...prev, [key]: true }));
            setComplementLoading(true);
            const url = `/api/tiny/dashboard/resumo?dataInicial=${inicio}&dataFinal=${fim}&complement=1`;
            const resC = await fetch(url, { cache: 'no-store' });
            if (resC.ok) {
              await carregarResumo();
              await fetchLastSync();
            } else {
              const j = await resC.json().catch(() => ({}));
              setComplementMsg(j?.message || 'Erro ao complementar automaticamente');
              setTimeout(() => setComplementMsg(null), 5000);
            }
            setComplementLoading(false);
          }
        } catch (e) {
          // swallow
        }
    } catch (e: any) {
      setErro(e?.message ?? 'Erro inesperado ao carregar dashboard');
      setResumo(null);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    carregarResumo();
    fetchLastSync();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [preset, customStart, customEnd, canaisSelecionados, situacoesSelecionadas]);

  async function fetchLastSync() {
    try {
      const res = await fetch('/api/tiny/sync/last-updated', { cache: 'no-store' });
      const j = await res.json();
      if (res.ok && j?.lastUpdated) {
        setLastSync(j.lastUpdated);
      } else {
        setLastSync(null);
      }
    } catch (e) {
      setLastSync(null);
    }
  }

  function resolverIntervaloChart(): { inicio: string; fim: string } {
    const hojeIso = isoToday();

    if (chartPreset === 'today') {
      return { inicio: hojeIso, fim: hojeIso };
    }
    if (chartPreset === '7d') {
      const fim = hojeIso;
      const inicio = addDays(fim, -6);
      return { inicio, fim };
    }
    if (chartPreset === '30d') {
      const fim = hojeIso;
      const inicio = addDays(fim, -29);
      return { inicio, fim };
    }
    if (chartPreset === 'month') {
      // Para 'month', usa o mês inteiro (1º até último dia), não até hoje
      const hoje = new Date(`${hojeIso}T00:00:00`);
      const inicio = startOfMonthFrom(hojeIso);
      const fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().slice(0, 10);
      return { inicio, fim };
    }
    if (chartCustomStart && chartCustomEnd) {
      return { inicio: chartCustomStart, fim: chartCustomEnd };
    }
    // fallback: mês atual inteiro
    const hoje = new Date(`${hojeIso}T00:00:00`);
    const inicio = startOfMonthFrom(hojeIso);
    const fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().slice(0, 10);
    return { inicio, fim };
  }

  async function carregarResumoChart() {
    try {
      setLoadingChart(true);
      setErroChart(null);

      const { inicio, fim } = resolverIntervaloChart();

      const params = new URLSearchParams();
      params.set('dataInicial', inicio);
      params.set('dataFinal', fim);
      // Importante: NÃO aplicar filtros de canais/situações aqui (filtro próprio)

      const res = await fetch(
        `/api/tiny/dashboard/resumo?${params.toString()}`,
        { cache: 'no-store' }
      );

      const json = await res.json();

      if (!res.ok) {
        const msg =
          json?.details || json?.message || 'Erro ao carregar resumo (gráfico)';
        throw new Error(msg);
      }

      setResumoChart(json as DashboardResumo);

      // Auto-complement: se for preset 'month' e tivermos menos dias retornados que o período,
      // tenta um complemento automático (apenas uma vez por intervalo) para preencher faltantes.
      try {
        const { inicio, fim } = resolverIntervaloChart();
        const diasEsperados = 1 + diffDays(inicio, fim);
        const atualDias = (json as DashboardResumo).periodoAtual.vendasPorDia.length ?? 0;
        const key = `${inicio}_${fim}`;
        const already = !!autoComplementedRanges[key];

        if (chartPreset === 'month' && !already && atualDias < diasEsperados) {
          // marque como tentado para evitar loops
          setAutoComplementedRanges((prev) => ({ ...prev, [key]: true }));
          // chama complement em background
          setComplementLoading(true);
          const url = `/api/tiny/dashboard/resumo?dataInicial=${inicio}&dataFinal=${fim}&complement=1`;
          const resC = await fetch(url, { cache: 'no-store' });
          if (resC.ok) {
            // recarrega o resumo do gráfico
            await carregarResumoChart();
          } else {
            // ignora erro — mostra mensagem curta
            const j = await resC.json().catch(() => ({}));
            setComplementMsg(j?.message || 'Erro ao complementar automaticamente');
            setTimeout(() => setComplementMsg(null), 5000);
          }
          setComplementLoading(false);
        }
      } catch (e) {
        // swallow
      }
    } catch (e: any) {
      setErroChart(e?.message ?? 'Erro inesperado ao carregar gráfico');
      setResumoChart(null);
    } finally {
      setLoadingChart(false);
    }
  }

  useEffect(() => {
    carregarResumoChart();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [chartPreset, chartCustomStart, chartCustomEnd]);

  async function handleComplementChart() {
    try {
      setComplementLoading(true);
      setComplementMsg(null);

      const { inicio, fim } = resolverIntervaloChart();

      const url = `/api/tiny/dashboard/resumo?dataInicial=${inicio}&dataFinal=${fim}&complement=1`;

      const res = await fetch(url, { cache: 'no-store' });
      const json = await res.json().catch(() => ({}));

      if (!res.ok) {
        const msg = json?.details || json?.message || `Erro ao complementar: ${res.status}`;
        setComplementMsg(msg);
        return;
      }

      setComplementMsg('Complemento realizado. Atualizando gráfico...');
      // refresh chart data
      await carregarResumoChart();
      await fetchLastSync();
      setComplementMsg('Gráfico atualizado com dados do Tiny.');
    } catch (e: any) {
      setComplementMsg(e?.message ?? 'Erro inesperado ao complementar.');
    } finally {
      setComplementLoading(false);
      // limpa mensagem depois de curto tempo
      setTimeout(() => setComplementMsg(null), 6_000);
    }
  }

  const chartData = useMemo(() => {
    if (!resumoChart) return [];

    const mapaAtual = new Map<string, number>();
    const mapaAnterior = new Map<string, number>();

    resumoChart.periodoAtual.vendasPorDia.forEach((d) =>
      mapaAtual.set(d.data, d.totalDia)
    );
    resumoChart.periodoAnterior.vendasPorDia.forEach((d) =>
      mapaAnterior.set(d.data, d.totalDia)
    );

    // Se for 'month', mostrar todos os dias de ambos os meses (incluindo dia 31 se houver)
    // Caso contrário, mostrar apenas o período atual
    let dates: string[] = [];
    
    if (chartPreset === 'month') {
      // Incluir todos os dias do período anterior
      let cursor = resumoChart.periodoAnterior.dataInicial;
      const diasSet = new Set<string>();
      while (cursor <= resumoChart.periodoAnterior.dataFinal) {
        const dia = cursor.split('-')[2];
        diasSet.add(dia);
        cursor = addDays(cursor, 1);
      }
      // Adicionar dias do período atual
      cursor = resumoChart.periodoAtual.dataInicial;
      while (cursor <= resumoChart.periodoAtual.dataFinal) {
        const dia = cursor.split('-')[2];
        diasSet.add(dia);
        cursor = addDays(cursor, 1);
      }
      // Converter para array e ordenar numericamente
      dates = Array.from(diasSet).sort((a, b) => Number(a) - Number(b));
    } else {
      // Para outros presets, apenas o período atual
      let cursor = resumoChart.periodoAtual.dataInicial;
      while (cursor <= resumoChart.periodoAtual.dataFinal) {
        dates.push(cursor);
        cursor = addDays(cursor, 1);
      }
    }

    return dates.map((dateOrDay) => {
      let diaDoMes: string;
      let dataAtual: string;
      
      if (chartPreset === 'month') {
        // dateOrDay é só o dia (ex: "05")
        diaDoMes = dateOrDay.padStart(2, '0');
        const diaNum = Number(diaDoMes);
        // Tentar encontrar em novembro primeiro
        dataAtual = resumoChart.periodoAtual.dataInicial.slice(0, 8) + diaDoMes;
        // Se esse dia não existe em novembro (ex: 31), ele virá com valor 0 do mapa
      } else {
        // dateOrDay é data completa (ex: "2025-11-05")
        dataAtual = dateOrDay;
        diaDoMes = dateOrDay.split('-')[2];
      }
      
      const dataAnteriorCorrespondente = resumoChart.periodoAnterior.dataInicial.slice(0, 8) + diaDoMes;
      
      return {
        data: diaDoMes, // mostra só o dia (05, 06, 07, ..., 31)
        atual: mapaAtual.get(dataAtual) ?? 0,
        anterior: mapaAnterior.get(dataAnteriorCorrespondente) ?? 0,
      };
    });
  }, [resumoChart, chartPreset]);

  const canaisData = useMemo(() => {
    if (!resumo) return [];
    return resumo.canais.map((c) => ({
      name: c.canal,
      value: c.totalValor,
      pedidos: c.totalPedidos,
    }));
  }, [resumo]);

  const variacaoValor = useMemo(() => {
    if (!resumo) return { abs: 0, perc: 0 };
    const atual = resumo.periodoAtual.totalValor;
    const ant = resumo.periodoAnterior.totalValor;
    const abs = atual - ant;
    const perc = ant > 0 ? (atual / ant - 1) * 100 : 0;
    return { abs, perc };
  }, [resumo]);

  const variacaoValorCards = useMemo(() => {
    if (!resumo) return { abs: 0, perc: 0 };
    const atual = resumo.periodoAtual.totalValor;
    const ant = resumo.periodoAnteriorCards.totalValor;
    const abs = atual - ant;
    const perc = ant > 0 ? (atual / ant - 1) * 100 : 0;
    return { abs, perc };
  }, [resumo]);

  const { inicio: intervaloInicio, fim: intervaloFim } = resolverIntervalo();
  const diasIntervalo =
    1 + Math.max(diffDays(intervaloInicio, intervaloFim), 0);

  const resumoAtual = resumo?.periodoAtual;

  function toggleCanal(canal: string) {
    setCanaisSelecionados((prev) =>
      prev.includes(canal)
        ? prev.filter((c) => c !== canal)
        : [...prev, canal]
    );
  }

  function toggleSituacao(sit: number) {
    setSituacoesSelecionadas((prev) =>
      prev.includes(sit)
        ? prev.filter((s) => s !== sit)
        : [...prev, sit]
    );
  }

  return (
    <AppLayout title="Dashboard Tiny">
      <div className="app-shell">
        <div className="app-shell-inner">
          {/* Header */}
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div className="space-y-1">
              <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">
                Visão Geral
              </h1>
              <p className="text-xs text-[var(--text-muted)]">
                Período de {intervaloInicio} até {intervaloFim} (
                {diasIntervalo} dias) – comparação com o período anterior.
              </p>
              {lastSync && (
                <p className="text-xs text-[var(--text-muted)] mt-1">
                  Última sincronização: {new Date(lastSync).toLocaleString()}
                </p>
              )}
            </div>

            {/* Filtros de data removidos - agora integrados com os outros filtros */}
          </div>

          {/* Filtros de canais, situações e período */}
          {resumo && (
            <div className="flex flex-wrap items-center gap-6">
              <div className="flex items-center gap-3">
                <span className="text-sm text-[var(--text-muted)]">Período:</span>
                <MultiSelectDropdown
                  label="Período"
                  options={[
                    { value: 'today', label: 'Hoje' },
                    { value: 'yesterday', label: 'Ontem' },
                    { value: '7d', label: '7 dias' },
                    { value: 'month', label: 'Mês' },
                    { value: '3m', label: '3 meses' },
                    { value: 'year', label: 'Ano' },
                    { value: 'custom', label: 'Personalizado' },
                  ]}
                  selected={[preset]}
                  onChange={(values) => setPreset(values[0] as DatePreset)}
                  onClear={() => setPreset('month')}
                  singleSelect={true}
                />
              </div>

              {preset === 'custom' && (
                <div className="flex items-center gap-3">
                  <input
                    type="date"
                    className="rounded-2xl border app-border-subtle bg-[var(--bg-card-soft)] px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-500"
                    value={customStart ?? ''}
                    onChange={(e) =>
                      setCustomStart(e.target.value || null)
                    }
                  />
                  <span className="text-sm text-[var(--text-muted)]">até</span>
                  <input
                    type="date"
                    className="rounded-2xl border app-border-subtle bg-[var(--bg-card-soft)] px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-500"
                    value={customEnd ?? ''}
                    onChange={(e) =>
                      setCustomEnd(e.target.value || null)
                    }
                  />
                </div>
              )}

              <div className="flex items-center gap-3">
                <span className="text-sm text-[var(--text-muted)]">Canais:</span>
                <MultiSelectDropdown
                  label="Canais"
                  options={resumo.canaisDisponiveis.map((canal) => ({
                    value: canal,
                    label: canal,
                  }))}
                  selected={canaisSelecionados}
                  onChange={(values) => setCanaisSelecionados(values as string[])}
                  onClear={() => setCanaisSelecionados([])}
                />
              </div>

              <div className="flex items-center gap-3">
                <span className="text-sm text-[var(--text-muted)]">Situações:</span>
                <MultiSelectDropdown
                  label="Situações"
                  options={resumo.situacoesDisponiveis.map((sit) => ({
                    value: sit.codigo,
                    label: sit.descricao,
                  }))}
                  selected={situacoesSelecionadas}
                  onChange={(values) => setSituacoesSelecionadas(values as number[])}
                  onClear={() => setSituacoesSelecionadas([])}
                />
              </div>
            </div>
          )}

          {/* Estados */}
          {loading && (
            <p className="text-sm text-[var(--text-muted)]">
              Carregando dados do Tiny…
            </p>
          )}
          {erro && (
            <p className="text-sm text-rose-400">
              Erro ao carregar dashboard: {erro}
            </p>
          )}

          {/* Conteúdo principal */}
          {!loading && !erro && resumo && resumoAtual && (
            <>
              {/* KPIs */}
              <div className="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-6">
                {/* Card Principal: Faturamento Bruto (1.5 colunas) */}
                <div className="app-card p-4 sm:p-6 w-full overflow-hidden flex flex-col sm:flex-row items-center sm:items-stretch gap-3 sm:gap-4 lg:col-span-3">
                  <div className="flex flex-col items-center justify-center flex-shrink-0 min-w-[48px]">
                    <div className="p-2 sm:p-3 rounded-2xl bg-emerald-500/20">
                      <TrendingUp className="w-6 h-6 sm:w-8 sm:h-8 text-emerald-500" />
                    </div>
                  </div>
                  <div className="flex-1 min-w-0 flex flex-col justify-between gap-2 sm:gap-3 text-center sm:text-left">
                    <div className="flex flex-col gap-1">
                      <span className="text-[10px] sm:text-[11px] text-[var(--text-muted)] uppercase tracking-wider font-medium">
                        Faturamento Bruto
                      </span>
                      <span className="text-xl sm:text-2xl font-bold text-emerald-500 line-clamp-1">
                        {formatBRL(resumoAtual.totalValor)}
                      </span>
                    </div>
                    <div className="pt-2 sm:pt-2 border-t app-border-subtle flex items-center justify-center sm:justify-start gap-2">
                      {variacaoValorCards.abs >= 0 ? (
                        <>
                          <ArrowUpRight className="w-4 h-4 text-emerald-500 flex-shrink-0" />
                          <span className="text-[11px] sm:text-[12px] text-emerald-500 font-medium">
                            +{variacaoValorCards.perc.toFixed(1)}%
                          </span>
                        </>
                      ) : (
                        <>
                          <ArrowDownRight className="w-4 h-4 text-rose-500 flex-shrink-0" />
                          <span className="text-[11px] sm:text-[12px] text-rose-500 font-medium">
                            {variacaoValorCards.perc.toFixed(1)}%
                          </span>
                        </>
                      )}
                    </div>
                  </div>
                </div>

                {/* Card: Faturamento Líquido (1.5 colunas) */}
                <div className="app-card p-4 sm:p-6 w-full overflow-hidden flex flex-col sm:flex-row items-center sm:items-stretch gap-3 sm:gap-4 lg:col-span-3">
                  <div className="flex flex-col items-center justify-center flex-shrink-0 min-w-[48px]">
                    <div className="p-2 sm:p-3 rounded-2xl bg-blue-500/20">
                      <BarChart3 className="w-6 h-6 sm:w-8 sm:h-8 text-blue-500" />
                    </div>
                  </div>
                  <div className="flex-1 min-w-0 flex flex-col justify-between gap-2 sm:gap-3 text-center sm:text-left">
                    <div className="flex flex-col gap-1">
                      <span className="text-[10px] sm:text-[11px] text-[var(--text-muted)] uppercase tracking-wider font-medium">
                        Faturamento Líquido
                      </span>
                      <span className="text-xl sm:text-2xl font-bold text-blue-500 line-clamp-1">
                        {formatBRL(resumoAtual.totalValorLiquido)}
                      </span>
                    </div>
                    <div className="pt-2 sm:pt-2 border-t app-border-subtle flex items-center justify-center sm:justify-start gap-2">
                      <span className="text-[11px] sm:text-[12px] text-[var(--text-muted)] font-medium">
                        Frete: {formatBRL(resumoAtual.totalFreteTotal)}
                      </span>
                    </div>
                  </div>
                </div>

                {/* Card 1: Pedidos */}
                <div className="app-card p-4 sm:p-6 w-full overflow-hidden flex flex-col sm:flex-row items-center sm:items-stretch gap-3 sm:gap-4">
                  <div className="flex flex-col items-center justify-center flex-shrink-0 min-w-[48px]">
                    <div className="p-2 sm:p-3 rounded-2xl bg-sky-500/20">
                      <ShoppingCart className="w-6 h-6 sm:w-8 sm:h-8 text-sky-500" />
                    </div>
                  </div>
                  <div className="flex-1 min-w-0 flex flex-col justify-between gap-2 sm:gap-3 text-center sm:text-left">
                    <div className="flex flex-col gap-1">
                      <span className="text-[10px] sm:text-[11px] text-[var(--text-muted)] uppercase tracking-wider font-medium">
                        Pedidos
                      </span>
                      <span className="text-xl sm:text-2xl font-bold">
                        {resumoAtual.totalPedidos.toLocaleString('pt-BR')}
                      </span>
                    </div>
                    <div className="pt-2 sm:pt-2 border-t app-border-subtle flex items-center justify-center sm:justify-start gap-2">
                      {resumoAtual.totalPedidos >= resumo.periodoAnteriorCards.totalPedidos ? (
                        <>
                          <ArrowUpRight className="w-4 h-4 text-emerald-500 flex-shrink-0" />
                          <span className="text-[11px] sm:text-[12px] text-emerald-500 font-medium">
                            +{resumoAtual.totalPedidos - resumo.periodoAnteriorCards.totalPedidos}
                          </span>
                        </>
                      ) : (
                        <>
                          <ArrowDownRight className="w-4 h-4 text-rose-500 flex-shrink-0" />
                          <span className="text-[11px] sm:text-[12px] text-rose-500 font-medium">
                            {resumoAtual.totalPedidos - resumo.periodoAnteriorCards.totalPedidos}
                          </span>
                        </>
                      )}
                    </div>
                  </div>
                </div>

                {/* Card 3: Ticket Médio */}
                <div className="app-card p-4 sm:p-6 w-full overflow-hidden flex flex-col sm:flex-row items-center sm:items-stretch gap-3 sm:gap-4">
                  <div className="flex flex-col items-center justify-center flex-shrink-0 min-w-[48px]">
                    <div className="p-2 sm:p-3 rounded-2xl bg-sky-400/20">
                      <BarChart3 className="w-6 h-6 sm:w-8 sm:h-8 text-sky-400" />
                    </div>
                  </div>
                  <div className="flex-1 min-w-0 flex flex-col justify-between gap-2 sm:gap-3 text-center sm:text-left">
                    <div className="flex flex-col gap-1">
                      <span className="text-[10px] sm:text-[11px] text-[var(--text-muted)] uppercase tracking-wider font-medium">
                        Ticket Médio
                      </span>
                      <span className="text-xl sm:text-2xl font-bold text-sky-400 line-clamp-1">
                        {formatBRL(resumoAtual.ticketMedio)}
                      </span>
                    </div>
                    <div className="pt-2 sm:pt-2 border-t app-border-subtle flex items-center justify-center sm:justify-start gap-2">
                      {resumoAtual.ticketMedio >= resumo.periodoAnteriorCards.ticketMedio ? (
                        <>
                          <ArrowUpRight className="w-4 h-4 text-emerald-500 flex-shrink-0" />
                          <span className="text-[11px] sm:text-[12px] text-emerald-500 font-medium truncate">
                            +{formatBRL(resumoAtual.ticketMedio - resumo.periodoAnteriorCards.ticketMedio)}
                          </span>
                        </>
                      ) : (
                        <>
                          <ArrowDownRight className="w-4 h-4 text-rose-500 flex-shrink-0" />
                          <span className="text-[11px] sm:text-[12px] text-rose-500 font-medium truncate">
                            {formatBRL(resumoAtual.ticketMedio - resumo.periodoAnteriorCards.ticketMedio)}
                          </span>
                        </>
                      )}
                    </div>
                  </div>
                </div>

                {/* Card 4: Comparativo */}
                <div className={`app-card p-4 sm:p-6 w-full overflow-hidden flex flex-col sm:flex-row items-center sm:items-stretch gap-3 sm:gap-4 ${variacaoValorCards.abs >= 0 ? 'ring-1 ring-emerald-500/30' : 'ring-1 ring-rose-500/30'}`}>
                  <div className="flex flex-col items-center justify-center flex-shrink-0 min-w-[48px]">
                    <div className={`p-2 sm:p-3 rounded-2xl ${variacaoValorCards.abs >= 0 ? 'bg-emerald-500/20' : 'bg-rose-500/20'}`}>
                      {variacaoValorCards.abs >= 0 ? (
                        <ArrowUpRight className="w-6 h-6 sm:w-8 sm:h-8 text-emerald-500" />
                      ) : (
                        <ArrowDownRight className="w-6 h-6 sm:w-8 sm:h-8 text-rose-500" />
                      )}
                    </div>
                  </div>
                  <div className="flex-1 min-w-0 flex flex-col justify-between gap-2 sm:gap-3 text-center sm:text-left">
                    <div className="flex flex-col gap-1">
                      <span className="text-[10px] sm:text-[11px] text-[var(--text-muted)] uppercase tracking-wider font-medium">
                        Variação
                      </span>
                      <span className={`text-xl sm:text-2xl font-bold ${variacaoValorCards.abs >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                        {variacaoValorCards.perc.toFixed(1)}%
                      </span>
                    </div>
                    <div className="pt-2 sm:pt-2 border-t app-border-subtle">
                      <span className="text-[11px] sm:text-[12px] text-[var(--text-muted)] truncate block">
                        {formatBRL(Math.abs(variacaoValorCards.abs))}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              {/* Gráfico + canais */}
              <div className="grid gap-4 lg:grid-cols-3">
                <div className="app-card p-4 lg:col-span-2">
                  <div className="flex items-center justify-between mb-3 gap-2 flex-wrap">
                    <h2 className="text-sm font-semibold">
                      Faturamento por dia
                    </h2>
                    <div className="flex items-center gap-2">
                      <div className="app-chip-group">
                        {[
                          ['today', 'Hoje'],
                          ['7d', '7 dias'],
                          ['30d', '30 dias'],
                          ['month', 'Mês'],
                          ['custom', 'Personalizado'],
                        ].map(([key, label]) => (
                          <button
                            key={key}
                            onClick={() => setChartPreset(key as ChartPreset)}
                            className={
                              'app-chip ' +
                              (chartPreset === key
                                ? 'app-chip-active'
                                : 'text-[var(--text-muted)] hover:bg-slate-200/60 dark:hover:bg-slate-800/80')
                            }
                          >
                            {label}
                          </button>
                        ))}
                      </div>
                      {chartPreset === 'custom' && (
                        <div className="flex items-center gap-2 text-[11px]">
                          <input
                            type="date"
                            className="rounded-full border app-border-subtle bg-[var(--bg-card-soft)] px-3 py-1 text-[11px] outline-none"
                            value={chartCustomStart ?? ''}
                            onChange={(e) => setChartCustomStart(e.target.value || null)}
                          />
                          <span className="text-[var(--text-muted)]">até</span>
                          <input
                            type="date"
                            className="rounded-full border app-border-subtle bg-[var(--bg-card-soft)] px-3 py-1 text-[11px] outline-none"
                            value={chartCustomEnd ?? ''}
                            onChange={(e) => setChartCustomEnd(e.target.value || null)}
                          />
                        </div>
                      )}
                      <div className="ml-2">
                        <button
                          onClick={handleComplementChart}
                          disabled={complementLoading}
                          className="px-3 py-1 rounded-2xl bg-sky-500 text-white text-[11px] hover:bg-sky-400 disabled:opacity-60"
                        >
                          {complementLoading ? 'Atualizando...' : 'Atualizar do Tiny'}
                        </button>
                        {complementMsg && (
                          <div className="text-[11px] text-[var(--text-muted)] mt-1">
                            {complementMsg}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                  {loadingChart && (
                    <p className="text-xs text-[var(--text-muted)] mb-2">Carregando gráfico…</p>
                  )}
                  {erroChart && (
                    <p className="text-xs text-rose-400 mb-2">{erroChart}</p>
                  )}
                  <div className="h-72">
                    <ResponsiveContainer width="100%" height="100%">
                      <AreaChart data={chartData}>
                        <defs>
                          <linearGradient
                            id="colorAtual"
                            x1="0"
                            y1="0"
                            x2="0"
                            y2="1"
                          >
                            <stop
                              offset="0%"
                              stopColor="#0ea5e9"
                              stopOpacity={0.6}
                            />
                            <stop
                              offset="100%"
                              stopColor="#0ea5e9"
                              stopOpacity={0.05}
                            />
                          </linearGradient>
                          <linearGradient
                            id="colorAnterior"
                            x1="0"
                            y1="0"
                            x2="0"
                            y2="1"
                          >
                            <stop
                              offset="0%"
                              stopColor="#64748b"
                              stopOpacity={0.6}
                            />
                            <stop
                              offset="100%"
                              stopColor="#64748b"
                              stopOpacity={0.05}
                            />
                          </linearGradient>
                        </defs>
                        <CartesianGrid
                          strokeDasharray="3 3"
                          vertical={false}
                          stroke="#1e293b"
                        />
                        <XAxis
                          dataKey="data"
                          tick={{ fontSize: 10, fill: '#cbd5f5' }}
                          tickMargin={8}
                        />
                        <YAxis
                          tickFormatter={(v) => formatBRL(Number(v))}
                          tick={{ fontSize: 10, fill: '#cbd5f5' }}
                          width={80}
                        />
                        <Tooltip
                          formatter={(value: any) =>
                            formatBRL(Number(value))
                          }
                          labelFormatter={(label) => `Data: ${label}`}
                          contentStyle={{
                            backgroundColor: '#020617',
                            border: '1px solid #1e293b',
                            borderRadius: 12,
                            fontSize: 11,
                          }}
                          labelStyle={{ color: '#e2e8f0' }}
                        />
                        <Legend
                          wrapperStyle={{
                            fontSize: 11,
                            color: '#cbd5f5',
                          }}
                        />
                        <Area
                          type="monotone"
                          dataKey="anterior"
                          name="Período anterior"
                          stroke="#64748b"
                          fill="url(#colorAnterior)"
                          strokeWidth={2}
                          strokeDasharray="4 4"
                        />
                        <Area
                          type="monotone"
                          dataKey="atual"
                          name="Período atual"
                          stroke="#0ea5e9"
                          fill="url(#colorAtual)"
                          strokeWidth={2}
                        />
                      </AreaChart>
                    </ResponsiveContainer>
                  </div>
                </div>

                <div className="app-card p-4">
                  <h2 className="text-sm font-semibold mb-2">
                    Faturamento por canal
                  </h2>
                  {canaisData.length === 0 ? (
                    <p className="text-xs text-[var(--text-muted)]">
                      Nenhum pedido no período filtrado.
                    </p>
                  ) : (
                    <div className="h-64">
                      <ResponsiveContainer width="100%" height="100%">
                        <PieChart>
                          <Pie
                            data={canaisData}
                            dataKey="value"
                            nameKey="name"
                            innerRadius={45}
                            outerRadius={75}
                            paddingAngle={2}
                          >
                            {canaisData.map((entry, index) => (
                              <Cell
                                key={entry.name}
                                fill={COLORS[index % COLORS.length]}
                              />
                            ))}
                          </Pie>
                          <Tooltip
                            formatter={(value: any, _name, payload: any) => [
                              formatBRL(Number(value)),
                              `${payload?.payload?.name} (${payload?.payload?.pedidos} pedidos)`,
                            ]}
                            contentStyle={{
                              backgroundColor: '#020617',
                              border: '1px solid #1e293b',
                              borderRadius: 12,
                              fontSize: 11,
                            }}
                            labelStyle={{ color: '#e2e8f0' }}
                          />
                        </PieChart>
                      </ResponsiveContainer>
                    </div>
                  )}
                </div>
              </div>

              {/* Tabelas detalhadas */}
              <div className="grid gap-4 lg:grid-cols-2">
                <div className="app-card p-4">
                  <h2 className="text-sm font-semibold mb-2">
                    Vendas por dia
                  </h2>
                  <div className="max-h-80 overflow-auto">
                    <table className="w-full text-[11px]">
                      <thead className="app-table-header">
                        <tr>
                          <th className="text-left px-2 py-1 text-[var(--text-muted)]">
                            Data
                          </th>
                          <th className="text-right px-2 py-1 text-[var(--text-muted)]">
                            Qtde pedidos
                          </th>
                          <th className="text-right px-2 py-1 text-[var(--text-muted)]">
                            Total do dia
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {resumoAtual.vendasPorDia.map((linha) => (
                          <tr
                            key={linha.data}
                            className="border-t app-border-subtle"
                          >
                            <td className="px-2 py-1">{linha.data}</td>
                            <td className="px-2 py-1 text-right">
                              {linha.quantidade}
                            </td>
                            <td className="px-2 py-1 text-right">
                              {formatBRL(linha.totalDia)}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>

                <div className="app-card p-4">
                  <h2 className="text-sm font-semibold mb-2">
                    Pedidos por situação
                  </h2>
                  <div className="max-h-80 overflow-auto">
                    <table className="w-full text-[11px]">
                      <thead className="app-table-header">
                        <tr>
                          <th className="text-left px-2 py-1 text-[var(--text-muted)]">
                            Situação
                          </th>
                          <th className="text-right px-2 py-1 text-[var(--text-muted)]">
                            Qtde
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {resumoAtual.pedidosPorSituacao.map((linha, idx) => (
                          <tr
                            key={idx}
                            className="border-t app-border-subtle"
                          >
                            <td className="px-2 py-1">
                              {labelSituacao(linha.situacao)}
                            </td>
                            <td className="px-2 py-1 text-right">
                              {linha.quantidade}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  <p className="text-[10px] text-[var(--text-muted)] mt-2">
                    O mapeamento de códigos de situação pode ser ajustado
                    conforme sua configuração do Tiny.
                  </p>
                </div>
              </div>
            </>
          )}
        </div>
      </div>
    </AppLayout>
  );
}