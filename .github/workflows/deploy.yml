name: Deploy to Hostinger

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.HOST_IP || secrets.HOSTINGER_HOST || secrets.SSH_HOST || secrets.SERVER_HOST }}
      DEPLOY_PORT: ${{ secrets.HOST_PORT || '65002' }}
    steps:
    - name: Validate SSH secrets
      run: |
        if [ -z "$DEPLOY_HOST" ]; then
          echo "Missing deploy host. Set HOST_IP (preferred) or HOSTINGER_HOST/SSH_HOST/SERVER_HOST."
          exit 1
        fi
        if [ -z "${{ secrets.HOST_USER }}" ]; then
          echo "Missing HOST_USER secret."
          exit 1
        fi
        if [ -z "${{ secrets.HOST_KEY }}" ] && [ -z "${{ secrets.HOST_KEY_B64 }}" ]; then
          echo "Missing HOST_KEY (private key) or HOST_KEY_B64."
          exit 1
        fi
    - name: Prepare SSH key
      env:
        HOST_KEY: ${{ secrets.HOST_KEY }}
        HOST_KEY_B64: ${{ secrets.HOST_KEY_B64 }}
      run: |
        if [ -n "$HOST_KEY_B64" ]; then
          echo "$HOST_KEY_B64" | base64 -d > /tmp/deploy_key
        else
          printf '%s' "$HOST_KEY" > /tmp/deploy_key
        fi
        chmod 600 /tmp/deploy_key
        if ! ssh-keygen -y -f /tmp/deploy_key > /dev/null 2>&1; then
          echo "Invalid SSH private key. Ensure HOST_KEY is the private key or set HOST_KEY_B64."
          exit 1
        fi
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.DEPLOY_HOST }}
        username: ${{ secrets.HOST_USER }}
        key_path: /tmp/deploy_key
        port: ${{ env.DEPLOY_PORT }} # Porta comum da Hostinger, ajuste se necessário via secret
        script: |
          export PATH="/opt/alt/alt-nodejs22/root/bin:$PATH"

          # Navegar para a pasta do projeto (ajuste o caminho se necessário)
          cd domains/gestao.ambientautilidades.com.br/public_html
          
          # 1. Pull do código
          git pull origin main
          
          # 2. Instalar dependências (produção)
          npm install
          
          # 3. Build Next.js
          npm run build
        
          # 4. Garantir assets no standalone (postbuild já faz isso)
          mkdir -p .next/standalone/.next/static .next/standalone/public
          cp -R .next/static/. .next/standalone/.next/static
          cp -R public/. .next/standalone/public

          # 5. Garantir startup file do Passenger e reiniciar
          if [ -f .htaccess ]; then
              sed -i 's/^PassengerStartupFile .*/PassengerStartupFile start-server.js/' .htaccess
          fi
          mkdir -p tmp && touch tmp/restart.txt
