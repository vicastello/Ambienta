name: Deploy to Hostinger

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.HOST_IP || secrets.HOSTINGER_HOST || secrets.SSH_HOST || secrets.SERVER_HOST }}
      DEPLOY_PORT: ${{ secrets.HOST_PORT || '65002' }}
    steps:
    - name: Validate SSH secrets
      run: |
        if [ -z "$DEPLOY_HOST" ]; then
          echo "Missing deploy host. Set HOST_IP (preferred) or HOSTINGER_HOST/SSH_HOST/SERVER_HOST."
          exit 1
        fi
        if [ -z "${{ secrets.HOST_USER }}" ]; then
          echo "Missing HOST_USER secret."
          exit 1
        fi
        if [ -z "${{ secrets.HOST_KEY }}" ]; then
          echo "Missing HOST_KEY secret."
          exit 1
        fi
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.DEPLOY_HOST }}
        username: ${{ secrets.HOST_USER }}
        key: ${{ secrets.HOST_KEY }}
        port: ${{ env.DEPLOY_PORT }} # Porta comum da Hostinger, ajuste se necessário via secret
        script: |
          export PATH="/opt/alt/alt-nodejs22/root/bin:$PATH"

          # Navegar para a pasta do projeto (ajuste o caminho se necessário)
          cd domains/gestao.ambientautilidades.com.br/public_html
          
          # 1. Pull do código
          git pull origin main
          
          # 2. Instalar dependências (produção)
          npm install
          
          # 3. Build Next.js
          npm run build
        
          # 4. Garantir assets no standalone (postbuild já faz isso)
          mkdir -p .next/standalone/.next/static .next/standalone/public
          cp -R .next/static/. .next/standalone/.next/static
          cp -R public/. .next/standalone/public
          
          # 5. Reiniciar aplicação (Assumindo PM2 ou kill simples)
          # Tenta recarregar via PM2 se existir, ou mata o node
          if command -v pm2 &> /dev/null; then
              pm2 reload all || pm2 restart all
          else
              # Método "bruto" para Hostinger Node App (Mata o processo node para que o painel reinicie)
              pkill -f "node .next/standalone/server.js" || echo "Nenhum processo rodando"
          fi
